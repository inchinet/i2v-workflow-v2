# I2V 工作流程 V2 - 分場影片生成器

> **注意**: 需要 VPN 連接到美國才能訪問 Google Gemini API

一個智能的圖像轉影片工作流程，可將您自己編寫的場景轉換為專業的電影級影片，配有**廣東話對白**和環境音效。

## 🎬 功能特點

- **10 個場景輸入**: 第一個場景必填，其餘 9 個選填，讓您完全控制故事內容
- **用戶自訂場景**: 您自己編寫每個場景的內容,電影分鏡,無需 AI 生成故事
- **雙人/單人主角支援**: 處理單主角和雙主角故事
- **廣東話音頻**: 所有角色對白均以**廣東話（粵語）**生成，配有環境音效
- **面部一致性**: 在所有場景中保持角色外觀、服裝和配飾
- **FFmpeg 影片合併**: 無損影片串聯，保留音頻質量和幀率
- **靈活的長寬比**: 支持橫向 (4:3) 和直向 (3:4) 格式
- **實時處理**: 圖像和影片生成過程中的實時狀態更新

## 📋 需求

- Node.js (v14 或更高版本)
- FFmpeg 已安裝並在系統 PATH 中可用
- Google Gemini API 金鑰（已啟用生成式 AI）
- VPN 連接到美國/新加坡/日本（對於 Gemini 受限的地區）

## 🚀 快速開始

### 1. 安裝依賴項

```bash
npm install
```

### 2. 啟動伺服器

```bash
node server.js
```

或使用批次檔：
```bash
start-server.bat
```

### 3. 在瀏覽器中打開

導航到: `http://localhost:3000`

## 🎯 使用方法

### 輸入要求

1. **女主角照片**（必填）
   - 上傳女角色的清晰照片
   - 面部將在所有場景中保持一致

2. **男主角照片**（選填）
   - 如果創建雙角色故事，請上傳
   - 留空以使用單主角模式

3. **場景描述**（場景 1 必填，場景 2-10 選填）
   - 用繁體中文描述每個場景, 電影分鏡
   - **重要：只描述視覺動作，避免寫對白**（對白可能觸發安全過濾器）
   - 每個場景最多 500 字符
   - ✅ 推薦：「兩位情侶在咖啡座，女主角微笑看著男主角，男主角害羞地點頭」
   - ❌ 避免：「女主角笑住講：『你今日好靚仔喎！』」（可能觸發 Veo 音頻安全過濾器）
   - **提示**：UI 上可能顯示預設的鏡頭標籤（如 "Wide Shot"），但**您在文字框輸入的指令擁有最高優先權**。如果您輸入了特定的分鏡術語，AI 將優先執行您的描述而非默認標籤。

   **💡 推薦的電影分鏡詞彙 (Cinematic Vocabulary):**
   - **鏡頭距離**:
     - `Wide Shot` (大遠景): 展示環境與人物的關係
     - `Mid Shot` (中景): 展示人物腰部以上，適合對話
     - `Close-up` (特寫): 展示人物面部表情
     - `Extreme Close-up` (大特寫): 展示眼睛、嘴唇等細節
   
   - **鏡頭運動**:
     - `Dolly In` (推鏡): 鏡頭向前推進，強調主體
     - `Dolly Out` (拉鏡): 鏡頭向後拉遠，揭示環境
     - `Pan Right` / `Pan Left` (運鏡): 鏡頭左右旋轉
     - `Tilt Up` / `Tilt Down` (搖鏡): 鏡頭上下傾斜
     - `Tracking Shot` (跟隨鏡頭): 鏡頭跟隨人物移動
     - `Arc Shot` (環繞鏡頭): 圍繞人物旋轉 360 度
     - `Crane Shot` (升降鏡頭): 鏡頭垂直升降
     - `Handheld` (手持): 模擬手持攝影機的晃動感，增加真實感
     
   - **視角**:
     - `Low Angle` (低視角): 從下往上拍，使人物顯得高大
     - `High Angle` (高視角): 從上往下拍
     - `Over the Shoulder` (過肩鏡頭): 隔著一個人的肩膀看另一個人，適合對話

4. **視覺細節**（選填）
   - 鎖定特定外觀細節：「保持人物容貌, 衣着, 耳環眼鏡, 化妝, 場景, 日夜, 室外/室內, 除非轉場境」
   - 確保一致性，除非場景轉換發生

5. **長寬比**
   - 橫向 (4:3) 用於電影級寬鏡頭
   - 直向 (3:4) 用於移動設備/社交媒體

6. **API 金鑰**
   - 輸入您的 Google Gemini API 金鑰
   - 自動保存到瀏覽器 localStorage

### 工作流程

1. 上傳主角照片
2. 填寫場景描述（至少場景 1）
3. 配置設置（長寬比、視覺細節）
4. 點擊**「生成最終影片」**→ 系統為每個場景生成圖像
5. 查看畫廊中生成的場景
6. Veo 3.1 為每個場景創建帶有廣東話音頻的影片
7. 下載單個場景片段或最終合併的 MP4

## 🎥 主要特點

系統自動：
- 檢測單主角與雙主角模式
- 為每個場景分配專業鏡頭運動（大遠景、中景、特寫、推鏡、運鏡）
- 保持視覺連續性（服裝、髮型、配飾、位置）
- 創建**廣東話對白**配環境音效
- 確保雙主角模式下兩個角色都出現在畫面中（適用時）
- 鎖定位置，除非在故事中明確更改

## 🔧 技術細節

### 架構

- **前端**: 原生 JavaScript，液態玻璃 UI 設計
- **後端**: Express.js 伺服器 (Node.js)
- **AI 模型**:
  - Nano Banana Pro / Gemini 圖像模型（場景圖像生成）
  - Veo 3.1（帶廣東話音頻的影片生成）
- **影片處理**: FFmpeg concat demuxer（無損合併）

### 檔案結構

```
i2v-workflow-v2/
├── index.html          # 主 UI
├── app.js              # 客戶端邏輯
├── style.css           # 液態玻璃樣式
├── server.js           # Express 伺服器 + FFmpeg 整合
├── uploads/            # 生成的場景圖像/影片
├── output/             # 最終合併的影片
├── package.json        # 依賴項
└── README.md           # 本檔案
```

### API 端點

- `POST /api/save-video` - 將影片 blob 保存為檔案
- `POST /api/concat-videos` - 使用 FFmpeg 合併影片
- `GET /api/download/:filename` - 下載最終影片

## 🎨 主要功能說明

### 視覺連續性鎖定

系統確保：
- **角色外觀**: 相同的面部、髮型、化妝
- **服裝**: 一致的服裝，除非場景改變
- **配飾**: 耳環、眼鏡、珠寶保持不變
- **位置**: 室內/室外、日/夜一致性
- **場景轉換**: 僅在故事明確要求時更改

### 廣東話音頻生成

所有影片包括：
- **廣東話（粵語）角色對白**
- 自然環境音效
- 電影背景音樂
- 與影片同步的高保真音頻

### FFmpeg 無損合併

- 使用 concat demuxer 配合 `-c copy` 標誌
- 無重新編碼 = 保留原始質量
- 保持音頻同步
- 保留幀率
- 單場景影片繞過合併（返回原始片段）

## 📝 注意事項

- 場景圖像可以在影片生成之前單獨下載
- 原始 Veo 片段保存在 `uploads/` 目錄中
- 最終合併的影片保存到 `output/` 目錄
- API 金鑰存儲在瀏覽器 localStorage 中（不發送到伺服器）
- 配額限制可能會觸發自動重試並倒計時

## 🐛 故障排除

### 「Cloud API 權限錯誤」
- 在 Google Cloud Console 中啟用生成式 AI API
- 確保 API 金鑰具有適當的權限

### 「地區受限」
- 連接到 VPN（美國/新加坡/日本）
- Gemini API 在香港/中國被封鎖

### 「配額已達」
- 系統自動重試並倒計時
- 等待配額重置或升級 API 計劃

### 最終影片中的黑屏/無音頻
- 確保已安裝 FFmpeg: `ffmpeg -version`
- 檢查 `uploads/` 中的原始片段是否有音頻
- 驗證正在使用 Veo 3.x 模型（支持音頻）

### Veo 安全過濾器阻止（RAI Filter）
- **症狀**：錯誤訊息顯示 "raiMediaFilteredReasons" 或 "audio safety filter"
- **原因**：場景描述中的對白觸發了 Veo 的內容安全過濾器
- **解決方法**：
  - ✅ 只描述視覺動作：「女主角微笑看著男主角」
  - ❌ 避免寫對白：「女主角講：你好靚仔！」
  - 移除所有引號內的對話內容
  - 使用中性的動作描述詞

### 服裝不一致問題
- 在「鎖定視覺細節」欄位中明確指定服裝
- 在每個場景描述中加入「保持相同服裝」
- 場景轉換時才允許更換服裝（例如：「可以換服裝」）

## 📝 注意事項

- 場景圖像可以在影片生成之前單獨下載
- 原始 Veo 片段保存在 `uploads/` 目錄中
- 最終合併的影片保存到 `output/` 目錄
- API 金鑰存儲在瀏覽器 localStorage 中（不發送到伺服器）
- 配額限制可能會觸發自動重試並倒計時

## 📄 授權

本專案供個人使用。請確保遵守 Google Gemini API 服務條款。

---

**技術支援**: Google Gemini AI, Veo 3.1, FFmpeg

## 🆕 V2 版本的新功能

- ✅ **10 個場景輸入**: 完全控制每個場景的內容
- ✅ **用戶自訂場景**: 您編寫場景，不依賴 AI 生成故事
- ✅ **繁體中文介面**: 所有 UI 元素均為繁體中文
- ✅ **廣東話對白強調**: 影片生成中明確要求廣東話
- ✅ **靈活的場景數量**: 僅填寫您需要的場景（1-10 個）
