# I2V 工作流程 V2 - 分場影片生成器

> **注意**: 需要 VPN 連接到美國才能訪問 Google Gemini API

>
> ![UI](https://github.com/inchinet/i2v-workflow-v2/blob/master/1.jpg)
> ![UI](https://github.com/inchinet/i2v-workflow-v2/blob/master/2.jpg)
> ![UI](https://github.com/inchinet/i2v-workflow-v2/blob/master/3.jpg)
> ![UI](https://github.com/inchinet/i2v-workflow-v2/blob/master/4.jpg)




一個智能的圖像轉影片工作流程，可將您自己編寫的場景轉換為專業的電影級影片，配有**廣東話對白**和環境音效。

## 🎬 功能特點

- **10 個場景輸入**: 第一個場景必填，其餘 9 個選填，讓您完全控制故事內容
- **用戶自訂場景**: 您自己編寫每個場景的內容,電影分鏡,無需 AI 生成故事
- **🆕 對白轉換器**: AI 自動將劇本格式對白轉換為敘述格式，適合 Veo 影片生成
- **🆕 5000 字符限制**: 每個場景支持最多 5000 字符，可容納詳細的場景描述
- **雙人/單人主角支援**: 處理單主角和雙主角故事
- **廣東話音頻**: 所有角色對白均以**廣東話（粵語）**生成，配有環境音效
- **🆕 增強面部一致性**: 強制 AI 保持角色的種族、膚色和面部特徵與參考照片完全一致
- **面部一致性**: 在所有場景中保持角色外觀、服裝和配飾
- **FFmpeg 影片合併**: 無損影片串聯，保留音頻質量和幀率
- **靈活的長寬比**: 支持橫向 (4:3) 和直向 (3:4) 格式
- **實時處理**: 圖像和影片生成過程中的實時狀態更新

## 📋 需求

- Node.js (v14 或更高版本)
- FFmpeg 已安裝並在系統 PATH 中可用
- Google Gemini API 金鑰（已啟用生成式 AI）
- VPN 連接到美國/新加坡/日本（對於 Gemini 受限的地區）

## 🚀 快速開始

### 1. 安裝依賴項

```bash
npm install
```

### 2. 啟動伺服器

```bash
node server.js
```

或使用批次檔：
```bash
start-server.bat
```

### 3. 在瀏覽器中打開

導航到: `http://localhost:3000`

## 🎯 使用方法

### 輸入要求

1. **女主角照片**（必填）
   - 上傳女角色的清晰照片
   - 面部將在所有場景中保持一致

2. **男主角照片**（選填）
   - 如果創建雙角色故事，請上傳
   - 留空以使用單主角模式

3. **場景描述**（場景 1 必填，場景 2-10 選填）
   - 用繁體中文描述每個場景, 電影分鏡
   - 每個場景最多 **5000 字符**（從 500 增加到 5000）
   - **🆕 兩種寫作方式**：
     
     **方式 1：直接寫敘述格式**（推薦）
     - ✅ 「男主角阿明緊張地問女主角阿花想喝什麼，然後說自己要美式咖啡不加糖。女主角阿花笑著回應。保持人物容貌, 髮型衣着, 化妝。」
     
     **方式 2：寫劇本格式 + 使用轉換器**
     - 先寫劇本格式：「阿明: (緊張地) 喂，阿花，想飲乜嘢？我要杯美式，唔加糖。」
     - 點擊 **🔄 轉換對白** 按鈕
     - 自動轉換為敘述格式
   
   - **提示**：UI 上可能顯示預設的鏡頭標籤（如 "Wide Shot"），但**您在文字框輸入的指令擁有最高優先權**。如果您輸入了特定的分鏡術語，AI 將優先執行您的描述而非默認標籤。

   **💡 推薦的電影分鏡詞彙 (Cinematic Vocabulary):**
   - **鏡頭距離**:
     - `Wide Shot` (大遠景): 展示環境與人物的關係
     - `Mid Shot` (中景): 展示人物腰部以上，適合對話
     - `Close-up` (特寫): 展示人物面部表情
     - `Extreme Close-up` (大特寫): 展示眼睛、嘴唇等細節
   
   - **鏡頭運動**:
     - `Dolly In` (推鏡): 鏡頭向前推進，強調主體
     - `Dolly Out` (拉鏡): 鏡頭向後拉遠，揭示環境
     - `Pan Right` / `Pan Left` (運鏡): 鏡頭左右旋轉
     - `Tilt Up` / `Tilt Down` (搖鏡): 鏡頭上下傾斜
     - `Tracking Shot` (跟隨鏡頭): 鏡頭跟隨人物移動
     - `Arc Shot` (環繞鏡頭): 圍繞人物旋轉 360 度
     - `Crane Shot` (升降鏡頭): 鏡頭垂直升降
     - `Handheld` (手持): 模擬手持攝影機的晃動感，增加真實感
     
   - **視角**:
     - `Low Angle` (低視角): 從下往上拍，使人物顯得高大
     - `High Angle` (高視角): 從上往下拍
     - `Over the Shoulder` (過肩鏡頭): 隔著一個人的肩膀看另一個人，適合對話

4. **視覺細節**（選填）
   - 鎖定特定外觀細節：「保持人物容貌, 髮型衣着, 耳環眼鏡, 化妝, 場景, 日夜, 室外/室內, 除非轉場境」
   - 確保一致性，除非場景轉換發生

5. **長寬比**
   - 橫向 (4:3) 用於電影級寬鏡頭
   - 直向 (3:4) 用於移動設備/社交媒體

6. **API 金鑰**
   - 輸入您的 Google Gemini API 金鑰
   - 自動保存到瀏覽器 localStorage

### 工作流程

1. 上傳主角照片
2. 填寫場景描述（至少場景 1）
3. 配置設置（長寬比、視覺細節）
4. 點擊**「生成最終影片」**→ 系統為每個場景生成圖像
5. 查看畫廊中生成的場景
6. Veo 3.1 為每個場景創建帶有廣東話音頻的影片
7. 下載單個場景片段或最終合併的 MP4

## 🎥 主要特點

系統自動：
- 檢測單主角與雙主角模式
- 為每個場景分配專業鏡頭運動（大遠景、中景、特寫、推鏡、運鏡）
- 保持視覺連續性（服裝、髮型、配飾、位置）
- 創建**廣東話對白**配環境音效
- 確保雙主角模式下兩個角色都出現在畫面中（適用時）
- 鎖定位置，除非在故事中明確更改

## 🔧 技術細節

### 架構

- **前端**: 原生 JavaScript，液態玻璃 UI 設計
- **後端**: Express.js 伺服器 (Node.js)
- **AI 模型**:
  - Nano Banana Pro / Gemini 圖像模型（場景圖像生成）
  - **Veo 3.1（預設影片生成模型）**：系統預設使用 Veo 3.1 生成帶廣東話音頻的影片
    - 自動嘗試順序：`veo-3.1-generate-preview` → `veo-3.0-generate-001` → `veo-3.0-fast-generate-001`
    - 所有 Veo 3.x 模型均支援音頻生成
- **影片處理**: FFmpeg concat demuxer（無損合併）

### 檔案結構

```
i2v-workflow-v2/
├── index.html          # 主 UI
├── app.js              # 客戶端邏輯
├── style.css           # 液態玻璃樣式
├── server.js           # Express 伺服器 + FFmpeg 整合
├── uploads/            # 生成的場景圖像/影片
├── output/             # 最終合併的影片
├── package.json        # 依賴項
└── README.md           # 本檔案
```

### API 端點

- `POST /api/save-video` - 將影片 blob 保存為檔案
- `POST /api/concat-videos` - 使用 FFmpeg 合併影片
- `GET /api/download/:filename` - 下載最終影片

## 🎨 主要功能說明

### 視覺與環境一致性鎖定 (Visual & Location Consistency Lock)
 
 系統現在採用更穩健的雙重鎖定機制：
 
 1.  **全面鎖定**: 您輸入的「鎖定視覺細節」規則（例如：`保持人物容貌, 髮型衣着, 耳環眼鏡, 化妝, 場景, 日夜, 室外/室內, 除非轉場境`）現在會被**強制**發送給：
     *   ✅ **圖像生成器 (NanoBananaPro)**：確保基礎場景圖像嚴格遵循您的環境和人物設定。
     *   ✅ **影片生成器 (Veo 3.1)**：確保生成的影片在運動中保持一致。
 
 2.  **鎖定範圍**:
     *   **角色外觀**: 相同的面部、髮型、化妝、配飾 (耳環、眼鏡)
     *   **服裝**: 強制一致，除非場景描述明確指出更換
     *   **環境/場景**: 室內/室外、光線 (日/夜) 嚴格鎖定，除非您明確寫出「轉場」
 
 ### Veo 3 預設提示詞結構

系統自動為每個場景生成以下格式的提示詞發送給 Veo 3：

```
🔴 CRITICAL: Facial appearance MUST be based on the provided reference image (Strict Face Consistency). 臉部外觀必須以提供的參考圖片為準（嚴格保持臉部一致性）。 🔴

視覺一致性要求 (VISUAL LOOK LOCK)：[您在「鎖定視覺細節」欄位中輸入的內容]

生成一段 [duration] 秒的電影級影片，基於以下分鏡：[您的場景描述]。

重要要求：
1. 音頻：所有角色對白和旁白必須100%使用廣東話（粵語/Cantonese）。
2. 服裝：請嚴格遵循「視覺一致性要求」內容，或依據場景描述。
3. 音效：包含自然環境音效和電影背景音樂。
4. 動作：確保動作逼真且高保真度。

CRITICAL: All dialogue and narration must be in Cantonese (廣東話). Facial consistency is paramount.
```

**說明**：
- `[duration]`：影片時長（預設 8 秒）
- `[您的場景描述]`：您在場景文字框中輸入的內容
- `[您在「鎖定視覺細節」欄位中輸入的內容]`：例如「保持人物容貌, 髮型衣着, 耳環眼鏡, 化妝, 場景, 日夜, 室外/室內, 除非轉場境」

### 廣東話音頻生成

所有影片包括：
- **廣東話（粵語）角色對白**（透過上述提示詞強制要求）
- 自然環境音效
- 電影背景音樂
- 與影片同步的高保真音頻

### FFmpeg 無損合併

- 使用 concat demuxer 配合 `-c copy` 標誌
- 無重新編碼 = 保留原始質量
- 保持音頻同步
- 保留幀率
- 單場景影片繞過合併（返回原始片段）

## 📝 注意事項

- 場景圖像可以在影片生成之前單獨下載
- 原始 Veo 片段保存在 `uploads/` 目錄中
- 最終合併的影片保存到 `output/` 目錄
- API 金鑰存儲在瀏覽器 localStorage 中（不發送到伺服器）
- 配額限制可能會觸發自動重試並倒計時

## 🐛 故障排除

### 「Cloud API 權限錯誤」
- 在 Google Cloud Console 中啟用生成式 AI API
- 確保 API 金鑰具有適當的權限

### 「地區受限」
- 連接到 VPN（美國/新加坡/日本）
- Gemini API 在香港/中國被封鎖

### 「配額已達」
- 系統自動重試並倒計時
- 等待配額重置或升級 API 計劃

### 最終影片中的黑屏/無音頻
- 確保已安裝 FFmpeg: `ffmpeg -version`
- 檢查 `uploads/` 中的原始片段是否有音頻
- 驗證正在使用 Veo 3.x 模型（支持音頻）

### Veo 安全過濾器阻止（RAI Filter）
- **症狀**：錯誤訊息顯示 "raiMediaFilteredReasons" 或 "audio safety filter"
- **原因**：場景描述中的對白觸發了 Veo 的內容安全過濾器
- **解決方法**：
  - ✅ 只描述視覺動作：「女主角微笑看著男主角」
  - ❌ 避免寫對白：「女主角講：你好靚仔！」
  - 移除所有引號內的對話內容
  - 使用中性的動作描述詞

### 服裝不一致問題
- 在「鎖定視覺細節」欄位中明確指定服裝
- 在每個場景描述中加入「保持相同服裝」
- 場景轉換時才允許更換服裝（例如：「可以換服裝」）

### 內搭衣物細節改變 (Inner Clothing Changes)
- **症狀**：男主角的藍色 T 恤變成了白襯衫，儘管已經鎖定了「藍色西裝」。
- **原因**：如果只描述「藍色西裝」，AI 可能會自由發揮內搭（T-shirt / 襯衫）。
- **解決方法**：在「鎖定視覺細節」中必須**精確描述內搭**。
  - ❌ 不夠精確：「男主角穿藍色西裝」
  - ✅ 精確描述：「男主角穿藍色西裝外套，內搭淺藍色圓領 T 恤 (Blue suit jacket with light blue round-neck T-shirt)」

### 面部一致性問題（角色種族/外觀改變）
- **症狀**：場景 2 中的角色變成了不同種族（例如：參考照片是亞洲人，但生成的是白人）
- **原因**：AI 圖像生成模型可能優先考慮場景描述而非參考照片
- **已修復**：系統現在使用增強的提示結構，將面部一致性要求置於最高優先級
- **工作原理**：
  - ✅ 參考照片指令放在提示的**最前面**
  - ✅ 明確要求保持種族、膚色、面部結構
  - ✅ 使用強制性語言（「MUST」、「CRITICAL PRIORITY」）
  - ✅ 每個場景都使用相同的參考照片
- **建議**：
  - 上傳清晰的正面照片作為參考
  - 確保參考照片光線充足、面部清晰
  - 如果仍有問題，在場景描述中明確提及角色的種族特徵

## 📝 注意事項

- 場景圖像可以在影片生成之前單獨下載
- 原始 Veo 片段保存在 `uploads/` 目錄中
- 最終合併的影片保存到 `output/` 目錄
- API 金鑰存儲在瀏覽器 localStorage 中（不發送到伺服器）
- 配額限制可能會觸發自動重試並倒計時

## 📄 授權

本專案供個人使用。請確保遵守 Google Gemini API 服務條款。

---

**技術支援**: Google Gemini AI, Veo 3.1, FFmpeg

## 🆕 V2 版本的新功能

- ✅ **10 個場景輸入**: 完全控制每個場景的內容
- ✅ **用戶自訂場景**: 您編寫場景，不依賴 AI 生成故事
- ✅ **繁體中文介面**: 所有 UI 元素均為繁體中文
- ✅ **廣東話對白強調**: 影片生成中明確要求廣東話
- ✅ **靈活的場景數量**: 僅填寫您需要的場景（1-10 個）
- 🆕 **5000 字符限制**: 每個場景從 500 增加到 5000 字符
- 🆕 **AI 對白轉換器**: 自動將劇本格式轉換為 Veo 兼容的敘述格式
- 🆕 **增強面部與環境一致性**: 除了面部，現在還強制鎖定場景環境、光線和服裝細節，確保圖像和影片的完美統一
- 🆕 **增強面部一致性**: 優先保持參考照片的種族和面部特徵，防止跨場景改變

### 對白轉換器功能

新增的 **🔄 轉換對白** 功能讓您可以：

1. **自然寫作**: 用劇本格式寫對白（例如：`阿明: 你好！`）
2. **一鍵轉換**: 點擊轉換按鈕
3. **AI 智能轉換**: 使用 Gemini API 自動轉換為敘述格式
4. **保留角色名**: 自動識別並保留角色名稱（例如：`男主角阿明`）
5. **廣東話支持**: 保持廣東話用詞和語氣

**支持的對白格式標籤**：
- `對白:` (推薦，無需星號)
- `Dialogue:`
- `**Dialogue:**`

**轉換示例**：
```
輸入：場景描述...
      對白: 
      阿明: (緊張地) 喂，阿花，想飲乜嘢？

      阿花: (笑住) 你知唔知美式係乜？

輸出：男主角阿明緊張地問女主角阿花想喝什麼，然後說自己要美式咖啡不加糖。
      女主角阿花笑著問他是否知道美式咖啡是什麼。保持人物容貌, 髮型衣着, 化妝。
```
